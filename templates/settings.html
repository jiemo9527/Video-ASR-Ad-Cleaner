<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å…¨å±€è®¾ç½® - Scanner Pro</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .kw-tag { cursor: pointer; user-select: none; transition: all 0.2s; font-size: 14px; }
        .kw-tag:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kw-tag.disabled { opacity: 0.6; text-decoration: line-through; background-color: #e9ecef !important; color: #6c757d !important; border-color: #dee2e6 !important; }
        .kw-close { margin-left: 8px; font-weight: bold; opacity: 0.7; transition: opacity 0.2s; }
        .kw-close:hover { opacity: 1; color: #dc3545; }
        .nav-tabs .nav-link { color: #495057; cursor: pointer; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-top: 3px solid #0d6efd; background: #fff; border-bottom-color: transparent; }
        .animate-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .form-check-input { margin-left: 0em !important; }
    </style>
</head>
<body class="bg-light">
<div id="app" class="container py-5" style="max-width: 1400px;">

    <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='favicon.png') }}" width="32" height="32" class="me-3" style="border-radius: 6px;">
            <h3 class="mb-0 fw-bold text-dark">ç³»ç»Ÿé«˜çº§é…ç½®</h3>
        </div>
        <div><a href="/" class="btn btn-outline-primary"><i class="bi bi-arrow-left"></i> è¿”å›æ§åˆ¶å°</a></div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 mb-4" style="min-height: 550px;">
                <div class="card-header bg-white pt-3 px-3 pb-0 border-bottom-0">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='basic', 'text-primary': settingTab==='basic'}" @click="settingTab='basic'"><i class="bi bi-sliders me-1"></i>åŸºç¡€</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='audio', 'text-success': settingTab==='audio'}" @click="settingTab='audio'"><i class="bi bi-soundwave me-1"></i>éŸ³é¢‘</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='model', 'text-danger': settingTab==='model'}" @click="settingTab='model'"><i class="bi bi-cpu me-1"></i>æ¨¡å‹</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='notify', 'text-warning': settingTab==='notify'}" @click="settingTab='notify'"><i class="bi bi-bell me-1"></i>é€šçŸ¥</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='queue', 'text-info': settingTab==='queue'}" @click="settingTab='queue'"><i class="bi bi-collection-play me-1"></i>é˜Ÿåˆ—</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small text-uppercase fw-bold" :class="{active: settingTab==='account', 'text-dark': settingTab==='account'}" @click="settingTab='account'"><i class="bi bi-shield-lock me-1"></i>è´¦æˆ·</button>
                        </li>
                    </ul>
                </div>

                <div class="card-body d-flex flex-column" style="padding: 3rem !important;">

                    <div class="flex-grow-1">

                        <div v-show="settingTab === 'basic'" class="animate-fade">
                            <h6 class="border-bottom pb-2 mb-3 text-muted small fw-bold">æ ¸å¿ƒæ£€æµ‹å¼€å…³</h6>
                            <div class="form-check form-switch mb-3 p-3 bg-light rounded border">
                                <input class="form-check-input" type="checkbox" v-model="settings.check_audio" id="sw_audio">
                                <label class="form-check-label fw-bold" for="sw_audio">éŸ³é¢‘è¿è§„æ£€æµ‹ (ASR)</label>
                                <div class="small text-muted mt-1" style="font-size: 11px">å¯ç”¨äº‘ç«¯/æœ¬åœ°æ¨¡å‹è¯†åˆ«éŸ³é¢‘ä¸­çš„æ•æ„Ÿè¯ã€‚</div>
                            </div>
                            <div class="form-check form-switch mb-3 p-3 bg-light rounded border">
                                <input class="form-check-input" type="checkbox" v-model="settings.check_subtitles" id="sw_sub">
                                <label class="form-check-label fw-bold" for="sw_sub">å­—å¹•å†…å®¹æ¸…æ´—</label>
                                <div class="small text-muted mt-1" style="font-size: 11px">æ‰«æå­—å¹•æµï¼Œè‡ªåŠ¨å‰”é™¤åŒ…å«æ¨å¹¿å…³é”®è¯çš„å­—å¹•è½¨ã€‚</div>
                            </div>
                            <div class="form-check form-switch mb-4 p-3 bg-light rounded border">
                                <input class="form-check-input" type="checkbox" v-model="settings.sanitize_metadata" id="sw_meta">
                                <label class="form-check-label fw-bold" for="sw_meta">å…ƒæ•°æ®æ·±åº¦æ¸…é™¤</label>
                                <div class="small text-muted mt-1" style="font-size: 11px">å¼ºåˆ¶æ¸…é™¤ Title/Comment ç­‰æ‰€æœ‰æ ‡ç­¾ (é˜²å¹¿å‘Š)ã€‚</div>
                            </div>

                            <div class="form-check form-switch mb-4 p-3 bg-light rounded border">
                                <input class="form-check-input" type="checkbox" v-model="settings.detailed_mode" id="sw_detail">
                                <label class="form-check-label fw-bold" for="sw_detail">è¯¦ç»†æ—¥å¿—æ¨¡å¼</label>
                                <div class="small text-muted mt-1" style="font-size: 11px">å¼€å¯åå°†å±•ç¤ºæ‰€æœ‰è¯†åˆ«åˆ°çš„æ–‡æœ¬å†…å®¹ï¼ˆæ— è®ºæ˜¯å¦è¿è§„ï¼‰ã€‚å…³é—­åˆ™ä»…å±•ç¤ºè¿è§„å†…å®¹ã€‚</div>
                            </div>

                            <h6 class="border-bottom pb-2 mb-3 text-muted small fw-bold mt-4">ç¯å¢ƒä¸è·¯å¾„é…ç½®</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold small">aria2ä¸‹è½½æ ¹ç›®å½•</label>
                                <input type="text" class="form-control form-control-sm font-monospace" v-model="settings.scan_path">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold small">é»˜è®¤ä¼ è¾“Rclone Remote(æ™ºèƒ½è·¯å¾„ä¸ç”Ÿæ•ˆæ—¶)</label>
                                <input type="text" class="form-control form-control-sm font-monospace" v-model="settings.rclone_remote">
                            </div>
                        </div>

                        <div v-show="settingTab === 'audio'" class="animate-fade">
                            <div class="mb-4">
                                <label class="form-label fw-bold small text-muted">è§¦å‘é˜ˆå€¼è®¾ç½®</label>
                                <div class="row g-2">
                                    <div class="col-12"><div class="input-group input-group-sm"><span class="input-group-text bg-white" style="width: 100px">å¤šæ®µæ£€æµ‹</span><input type="number" class="form-control" v-model="settings.audio_threshold_multi"><span class="input-group-text">ç§’</span></div></div>
                                    <div class="col-12"><div class="input-group input-group-sm"><span class="input-group-text bg-white" style="width: 100px">è¶…é•¿å®šä¹‰</span><input type="number" class="form-control" v-model="settings.audio_threshold_long"><span class="input-group-text">ç§’</span></div></div>
                                </div>
                            </div>
                            <hr class="text-muted opacity-25">
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">é‡‡æ ·é•¿åº¦æ§åˆ¶</label>
                                <div class="row g-2">
                                    <div class="col-6"><label class="small text-muted mb-1">ç‰‡å¤´é•¿åº¦</label><input type="number" class="form-control form-control-sm" v-model="settings.audio_len_head"></div>
                                    <div class="col-6"><label class="small text-muted mb-1">ä¸­é—´é•¿åº¦</label><input type="number" class="form-control form-control-sm" v-model="settings.audio_len_mid"></div>
                                    <div class="col-6"><label class="small text-muted mb-1">æ ‡å‡†ç‰‡å°¾</label><input type="number" class="form-control form-control-sm" v-model="settings.audio_len_tail"></div>
                                    <div class="col-6"><label class="small text-muted mb-1">è¶…é•¿ç‰‡å°¾</label><input type="number" class="form-control form-control-sm" v-model="settings.audio_len_tail_long"></div>
                                </div>
                            </div>
                        </div>

                        <div v-show="settingTab === 'model'" class="animate-fade">
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2 mb-3 text-muted small fw-bold">â˜ï¸ API äº‘ç«¯æ¨¡å‹</h6>
                                <div class="mb-3"><label class="form-label fw-bold small">API Endpoint (URL)</label><input type="text" class="form-control form-control-sm font-monospace" v-model="settings.api_url"></div>
                                <div class="mb-3"><label class="form-label fw-bold small">API Key</label><div class="input-group input-group-sm"><input type="password" class="form-control font-monospace" v-model="settings.api_key" id="apiKeyInput"><button class="btn btn-outline-secondary" type="button" onclick="const i=document.getElementById('apiKeyInput');i.type=i.type==='password'?'text':'password'"><i class="bi bi-eye"></i></button></div></div>
                                <div class="mb-3"><label class="form-label fw-bold small">Model Name</label><input type="text" class="form-control form-control-sm" v-model="settings.api_model"></div>
                            </div>
                            <div class="mb-2">
                                <h6 class="border-bottom pb-2 mb-3 text-muted small fw-bold">ğŸ  æœ¬åœ°æ¨¡å‹èµ„æº</h6>
                                <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" v-model="settings.enable_local_model" id="sw_local" :disabled="!modelReady"><label class="form-check-label fw-bold" for="sw_local">å¯ç”¨æœ¬åœ°æ¨¡å‹ (Fallback)</label></div>
                                <div v-if="!modelReady" class="text-danger small mb-2" style="font-size: 11px; margin-left: 2em;"><i class="bi bi-x-circle me-1"></i> æ£€æµ‹åˆ°æœ¬åœ°æ¨¡å‹æ–‡ä»¶ç¼ºå¤±ï¼Œæ— æ³•å¯ç”¨ã€‚è¯·å…ˆä¸‹è½½ã€‚</div>
                                <div class="mb-3"><label class="form-label fw-bold small">ä¸‹è½½ä»£ç† (Proxy)</label><input type="text" class="form-control form-control-sm font-monospace" v-model="settings.download_proxy" placeholder="http://127.0.0.1:7890"></div>
                                <div class="card bg-light border-0 p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2"><span class="fw-bold small">SenseVoice (ONNX/Torch)</span><span class="badge" :class="modelReady ? 'bg-success' : 'bg-secondary'">[[ modelReady ? 'å·²å°±ç»ª' : 'æœªæ£€æµ‹/ç¼ºå¤±' ]]</span></div>
                                    <button class="btn btn-outline-primary btn-sm w-100" @click="startDownloadModel"><i class="bi bi-cloud-download me-1"></i> ä¸€é”®ä¸‹è½½ / æ›´æ–°æ¨¡å‹èµ„æº</button>
                                </div>
                            </div>
                        </div>

                        <div v-show="settingTab === 'notify'" class="animate-fade">
                            <div class="text-center py-4 text-muted"><i class="bi bi-telegram fs-1 d-block mb-3 text-primary opacity-75"></i><h6 class="fw-bold">Telegram æœºå™¨äººé€šçŸ¥</h6></div>
                            <div class="mb-3"><label class="form-label fw-bold small">Bot Token</label><input type="text" class="form-control" v-model="settings.tg_bot_token"></div>
                            <div class="mb-4"><label class="form-label fw-bold small">Chat ID</label><input type="text" class="form-control" v-model="settings.tg_chat_id"></div>
                            <h6 class="fw-bold small mb-3 text-muted">é€šçŸ¥è§¦å‘æ¡ä»¶</h6>
                            <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" v-model="settings.notify_upload_success" id="notify_success"><label class="form-check-label small" for="notify_success">ä¸Šä¼ æˆåŠŸé€šçŸ¥</label></div>
                            <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" v-model="settings.notify_errors" id="notify_error"><label class="form-check-label small" for="notify_error">å¤±è´¥/å¼‚å¸¸é€šçŸ¥</label></div>
                        </div>

                        <div v-show="settingTab === 'queue'" class="animate-fade">
                            <div class="alert alert-warning border-0 py-2 small mb-4"><i class="bi bi-exclamation-triangle-fill me-1"></i> <strong>æ³¨æ„ï¼š</strong> ä¿®æ”¹å¹¶å‘æ•°éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚</div>
                            <div class="row g-3">
                                <div class="col-12"><label class="form-label fw-bold small">ğŸ•µï¸ æ£€æµ‹å¹¶å‘æ•°</label><div class="input-group input-group-sm"><button class="btn btn-outline-secondary" @click="settings.concurrency_detect > 1 && settings.concurrency_detect--"><i class="bi bi-dash"></i></button><input type="number" class="form-control text-center font-monospace" v-model="settings.concurrency_detect" min="1" max="10"><button class="btn btn-outline-secondary" @click="settings.concurrency_detect++"><i class="bi bi-plus"></i></button></div></div>
                                <div class="col-12"><label class="form-label fw-bold small">â˜ï¸ ä¸Šä¼ å¹¶å‘æ•°</label><div class="input-group input-group-sm"><button class="btn btn-outline-secondary" @click="settings.concurrency_upload > 1 && settings.concurrency_upload--"><i class="bi bi-dash"></i></button><input type="number" class="form-control text-center font-monospace" v-model="settings.concurrency_upload" min="1" max="20"><button class="btn btn-outline-secondary" @click="settings.concurrency_upload++"><i class="bi bi-plus"></i></button></div></div>
                            </div>
                            <hr class="my-4 text-muted opacity-25">
                            <div class="d-grid"><button class="btn btn-danger py-2 shadow-sm rounded-3" @click="saveAndRestart"><i class="bi bi-bootstrap-reboot me-2"></i>ä¿å­˜å¹¶é‡å¯æœåŠ¡</button></div>
                        </div>

                        <div v-show="settingTab === 'account'" class="animate-fade">
                            <h6 class="border-bottom pb-2 mb-3 text-muted small fw-bold">ğŸ”— API æ¥å…¥é‰´æƒ</h6>
                            <div class="mb-4">
                                <label class="form-label fw-bold small">Trigger API Token</label>
                                <input type="text" class="form-control form-control-sm font-monospace" v-model="settings.api_token">
                                <div class="form-text text-success" style="font-size: 11px">
                                    <i class="bi bi-check-circle-fill"></i> ä¿®æ”¹ä¿å­˜åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åŒæ­¥æ›´æ–° <code>trigger.sh</code> è„šæœ¬ã€‚
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary w-100" @click="saveSettings" :disabled="saving">
                                        <span v-if="saving" class="spinner-border spinner-border-sm me-2"></span>
                                        <span v-else><i class="bi bi-save-fill me-2"></i></span>
                                        ä¿å­˜ API Token
                                    </button>
                                </div>
                            </div>

                            <hr class="my-4 text-muted opacity-25">

                            <h6 class="border-bottom pb-2 mb-4 text-muted small fw-bold">ğŸ›¡ï¸ ç®¡ç†å‘˜å‡­è¯è®¾ç½®</h6>
                            <div class="alert alert-light border small mb-3"><i class="bi bi-info-circle me-1"></i> è‹¥ä»…ä¿®æ”¹ç”¨æˆ·åï¼Œç•™ç©ºå¯†ç æ¡†å³å¯ã€‚</div>
                            <div class="mb-3"><label class="form-label small fw-bold">ç”¨æˆ·å (Username)</label><input type="text" class="form-control" v-model="account.username" placeholder="Admin Username"></div>
                            <div class="mb-3"><label class="form-label small fw-bold">å½“å‰æ—§å¯†ç  (éªŒè¯ç”¨)</label><input type="password" class="form-control" v-model="account.old_pass" placeholder="Current Password (Required)"></div>
                            <div class="row g-2">
                                <div class="col-6"><label class="form-label small fw-bold">æ–°å¯†ç </label><input type="password" class="form-control" v-model="account.new_pass" placeholder="New Password"></div>
                                <div class="col-6"><label class="form-label small fw-bold">ç¡®è®¤æ–°å¯†ç </label><input type="password" class="form-control" v-model="account.confirm_pass" placeholder="Confirm"></div>
                            </div>
                            <div class="mt-4"><button class="btn btn-dark w-100 py-2" @click="updateAccount" :disabled="saving"><i class="bi bi-shield-check me-2"></i>æ›´æ–°è´¦æˆ·å‡­è¯</button></div>
                        </div>

                    </div>

                    <div class="mt-4" v-if="settingTab !== 'queue' && settingTab !== 'account'">
                        <button class="btn btn-primary w-100 py-2 rounded-3" @click="saveSettings" :disabled="saving">
                            <span v-if="saving" class="spinner-border spinner-border-sm me-2"></span>
                            <span v-else><i class="bi bi-save me-2"></i></span>
                            ä¿å­˜å½“å‰é…ç½®
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between align-items-center"><span><i class="bi bi-key text-success me-2"></i>å…³é”®è¯å‘½ä¸­</span><button class="btn btn-sm btn-success px-3" @click="openAddModal"><i class="bi bi-plus-lg me-1"></i>æ–°å¢</button></div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4"><li class="nav-item"><button class="nav-link" :class="{active: tab==='audio'}" @click="tab='audio'">ğŸ”Š éŸ³é¢‘ <span class="badge bg-secondary ms-1 rounded-pill">[[ getCount('audio') ]]</span></button></li><li class="nav-item"><button class="nav-link" :class="{active: tab==='subtitle'}" @click="tab='subtitle'">ğŸ“ å­—å¹• <span class="badge bg-secondary ms-1 rounded-pill">[[ getCount('subtitle') ]]</span></button></li><li class="nav-item"><button class="nav-link" :class="{active: tab==='meta'}" @click="tab='meta'">ğŸ·ï¸ å…ƒæ•°æ® <span class="badge bg-secondary ms-1 rounded-pill">[[ getCount('meta') ]]</span></button></li></ul>
                    <div class="d-flex flex-wrap gap-2 align-content-start" style="min-height: 200px;">
                        <div v-for="kw in currentList" :key="kw.id" class="badge rounded-pill p-2 ps-3 kw-tag border" :class="kw.enabled ? 'bg-primary text-white' : 'disabled'" @click="toggleKw(kw)">[[ kw.content ]] <span class="kw-close" @click.stop="confirmAction('åˆ é™¤æ­¤å…³é”®è¯ï¼Ÿ', () => deleteKw(kw.id))"><i class="bi bi-x-lg"></i></span></div>
                        <div v-if="currentList.length === 0" class="w-100 text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>æš‚æ—  [[ tabName ]] å…³é”®è¯</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"><div id="liveToast" class="toast align-items-center text-white border-0" :class="toastClass" role="alert"><div class="d-flex"><div class="toast-body"><i :class="toastIcon" class="me-2"></i> [[ toastMsg ]]</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="modal-title fs-6 fw-bold text-danger">âš ï¸ ç¡®è®¤æ“ä½œ</h5></div><div class="modal-body">[[ confirmMsg ]]</div><div class="modal-footer border-0 pt-0"><button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-sm btn-danger" @click="executeConfirm">ç¡®å®š</button></div></div></div></div>
    <div class="modal fade" id="addKwModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">æ–°å¢ [[ tabName ]] å…³é”®è¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label fw-bold">å…³é”®è¯å†…å®¹</label><input type="text" class="form-control" v-model="newKw" placeholder="ä¾‹å¦‚ï¼šåŠ ç¾¤|å¾®ä¿¡|æ¨å¹¿" @keyup.enter="addKw"><div class="form-text text-muted">ğŸ’¡ æ”¯æŒæ‰¹é‡æ·»åŠ ï¼šä½¿ç”¨ç«–çº¿ <code>|</code> åˆ†éš”å¤šä¸ªè¯ã€‚</div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" @click="addKw">ç¡®è®¤æ·»åŠ </button></div></div></div></div>
    <div class="modal fade" id="downloadLogModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-dark text-white border-0"><h5 class="modal-title fs-6"><i class="bi bi-terminal me-2"></i>æ¨¡å‹èµ„æºä¸‹è½½å™¨</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-black p-0"><div ref="logBox" class="p-3 font-monospace" style="height: 400px; overflow-y: auto; color: #0f0; font-size: 12px; line-height: 1.5; white-space: pre-wrap;">[[ downloadLogs ]]</div></div><div class="modal-footer bg-dark border-0 py-2"><div v-if="downloading" class="d-flex align-items-center text-white small me-auto"><span class="spinner-border spinner-border-sm me-2"></span> æ­£åœ¨ä¸‹è½½ä¸­...</div><button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">[[ downloading ? 'éšè—çª—å£ (åå°ç»§ç»­)' : 'å…³é—­' ]]</button></div></div></div></div>

</div>

<script>
let modalAdd, modalConfirm, toastInstance, modalDownload;

Vue.createApp({
    delimiters: ['[[', ']]'],
    data(){
        return{
            settingTab: 'basic',
            settings: {
                check_audio: true, check_subtitles: true, sanitize_metadata: true, enable_local_model: false,
                detailed_mode: false,
                tg_bot_token: '', tg_chat_id: '',
                audio_threshold_multi: 600, audio_threshold_long: 3600,
                audio_len_head: 240, audio_len_mid: 240, audio_len_tail: 300, audio_len_tail_long: 600,
                api_url: '', api_key: '', api_model: '',
                scan_path: '', rclone_remote: '', api_token: '',
                notify_upload_success: false, notify_errors: true,
                concurrency_detect: 2, concurrency_upload: 9,
                download_proxy: ''
            },
            account: { username: '', old_pass: '', new_pass: '', confirm_pass: '' },
            keywords: [], tab: 'audio', newKw: '', saving: false,
            toastMsg: '', toastClass: 'bg-primary', toastIcon: 'bi-info-circle',
            confirmMsg: '', confirmCallback: null,
            downloadLogs: 'ç­‰å¾…å¯åŠ¨...', downloading: false, timer: null, modelReady: false
        }
    },
    computed: {
        currentList() { return this.keywords.filter(k => k.type === this.tab); },
        tabName() { const map = {'audio': 'éŸ³é¢‘', 'subtitle': 'å­—å¹•', 'meta': 'å…ƒæ•°æ®'}; return map[this.tab]; }
    },
    mounted(){
        this.loadSettings(); this.loadKeywords();
        modalAdd = new bootstrap.Modal(document.getElementById('addKwModal'));
        modalConfirm = new bootstrap.Modal(document.getElementById('confirmModal'));
        modalDownload = new bootstrap.Modal(document.getElementById('downloadLogModal'));
        toastInstance = new bootstrap.Toast(document.getElementById('liveToast'));
    },
    methods:{
        showToast(msg, type='success'){
            this.toastMsg = msg;
            this.toastClass = type==='success' ? 'bg-success' : 'bg-danger';
            this.toastIcon = type==='success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
            toastInstance.show();
        },
        confirmAction(msg, action){ this.confirmMsg = msg; this.confirmCallback = action; modalConfirm.show(); },
        executeConfirm(){ if(this.confirmCallback) this.confirmCallback(); modalConfirm.hide(); },

        loadSettings(){
            axios.get('/api/settings').then(r=>{
                const d = r.data;
                ['check_audio','check_subtitles','sanitize_metadata', 'enable_local_model', 'detailed_mode', 'notify_upload_success', 'notify_errors'].forEach(k => this.settings[k] = (d[k]===true || d[k]==='true'));
                this.settings.tg_bot_token = d.tg_bot_token||'';
                this.settings.tg_chat_id = d.tg_chat_id||'';
                const numKeys = ['audio_threshold_multi', 'audio_threshold_long', 'audio_len_head', 'audio_len_mid', 'audio_len_tail', 'audio_len_tail_long', 'concurrency_detect', 'concurrency_upload'];
                numKeys.forEach(k => { if(d[k] !== undefined) this.settings[k] = d[k]; });
                this.settings.api_url = d.api_url || '';
                this.settings.api_key = d.api_key || '';
                this.settings.api_model = d.api_model || '';
                this.settings.scan_path = d.scan_path || '/root/downloads';
                this.settings.rclone_remote = d.rclone_remote || 's25';
                this.settings.api_token = d.api_token || '8pUoqOTHhEAhRnacl3c19';
                this.settings.download_proxy = d.download_proxy || '';
                this.modelReady = d.model_exists === true;
                if(!this.modelReady && this.settings.enable_local_model) this.settings.enable_local_model = false;
                if(d.username) this.account.username = d.username;
            })
        },
        saveSettings(){
            this.saving = true;
            axios.post('/api/settings', this.settings).then(()=>{
                setTimeout(()=>{ this.saving=false; this.showToast('é…ç½®å·²ä¿å­˜'); }, 500);
            }).catch(() => { this.saving = false; this.showToast('ä¿å­˜å¤±è´¥', 'error'); });
        },
        saveAndRestart(){
            this.saving = true;
            axios.post('/api/settings', this.settings).then(()=>{
                this.showToast('é…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨é‡å¯...');
                axios.post('/api/restart').then(res => { setTimeout(() => { location.reload(); }, 3000); }).catch(()=>{ this.showToast('é‡å¯å‘½ä»¤å‘é€å¤±è´¥', 'error'); this.saving = false; });
            });
        },
        updateAccount() {
            if(!this.account.old_pass) return this.showToast('å¿…é¡»è¾“å…¥æ—§å¯†ç ä»¥éªŒè¯èº«ä»½', 'error');
            if(this.account.new_pass && this.account.new_pass !== this.account.confirm_pass) return this.showToast('ä¸¤æ¬¡æ–°å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');

            this.saving = true;
            axios.post('/api/account/update', {
                old_password: this.account.old_pass,
                new_password: this.account.new_pass,
                new_username: this.account.username
            }).then(res => {
                this.saving = false;
                if(res.data.code === 200) {
                    this.showToast('è´¦æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•');
                    setTimeout(() => location.href='/logout', 1000);
                } else {
                    this.showToast(res.data.msg, 'error');
                }
            }).catch(err => {
                this.saving = false;
                this.showToast(err.response?.data?.msg || 'è¯·æ±‚å¤±è´¥', 'error');
            });
        },
        loadKeywords(){ axios.get('/api/keywords').then(r => this.keywords = r.data); },
        getCount(type){ return this.keywords.filter(k => k.type === type).length; },
        toggleKw(kw){ axios.put('/api/keyword/'+kw.id, {enabled: !kw.enabled}).then(this.loadKeywords); },
        deleteKw(id){ axios.delete('/api/keyword/'+id).then(()=>{ this.loadKeywords(); this.showToast('å…³é”®è¯å·²åˆ é™¤'); }); },
        openAddModal(){ this.newKw = ''; modalAdd.show(); },
        addKw(){
            if(!this.newKw.trim()) return;
            axios.post('/api/keywords', { type: this.tab, content: this.newKw }).then(res => { modalAdd.hide(); this.loadKeywords(); this.showToast(`æˆåŠŸæ·»åŠ  ${res.data.added} ä¸ªå…³é”®è¯`); });
        },
        startDownloadModel() {
            this.downloadLogs = "ğŸš€ æ­£åœ¨è¯·æ±‚å¯åŠ¨ä¸‹è½½ä»»åŠ¡..."; this.downloading = true; modalDownload.show();
            axios.post('/api/model/download').then(res => { if(res.data.code === 200 || res.data.code === 409) this.pollDownloadLog(); else { this.downloadLogs = "âŒ " + res.data.msg; this.downloading = false; } }).catch(e => { this.downloadLogs = "âŒ " + e.message; this.downloading = false; });
        },
        pollDownloadLog() {
            if(this.timer) clearTimeout(this.timer);
            axios.get('/api/model/log').then(res => {
                const data = res.data; this.downloadLogs = data.logs || 'æš‚æ— æ—¥å¿—...'; this.downloading = data.running;
                this.$nextTick(() => { const el = this.$refs.logBox; if(el) el.scrollTop = el.scrollHeight; });
                if (data.running) this.timer = setTimeout(this.pollDownloadLog, 1000);
                else { this.showToast('ä¸‹è½½ä»»åŠ¡å·²ç»“æŸ'); this.loadSettings(); }
            }).catch(() => { this.downloading = false; });
        }
    }
}).mount('#app')
</script>
</body>
</html>