<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scanner Pro Dashboard</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .task-log-box {
            height: 50px; overflow-y: hidden; background: #212529; color: #28a745;
            font-family: 'Consolas', monospace; font-size: 11px; padding: 5px 8px;
            border-radius: 3px; cursor: zoom-in; position: relative; line-height: 1.3;
        }
        .task-log-box:hover { background: #2c3034; }
        .sys-log-box {
            background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace;
            font-size: 13px; padding: 15px; border-radius: 4px; height: calc(100vh - 380px);
            min-height: 500px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5; border: 1px solid #343a40;
        }
        .config-dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
        .dot-on { background-color: #198754; box-shadow: 0 0 4px #198754; }
        .dot-processing { background-color: #0d6efd; animation: pulse 1s infinite; }
        .dot-dirty { background-color: #dc3545; box-shadow: 0 0 4px #dc3545; }
        .dot-off { background-color: #adb5bd; opacity: 0.3; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; border-radius: 4px 4px 0 0; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-top: 3px solid #0d6efd; background: #fff; border-bottom-color: transparent; }
        .full-log-content { background: #0d1117; color: #e6edf3; font-family: 'Consolas', monospace; font-size: 13px; padding: 20px; height: 75vh; overflow-y: auto; white-space: pre-wrap; }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="bg-light">
<div id="app" class="container-fluid px-4 py-4">

    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border">
        <div class="d-flex align-items-center">
            <h4 class="mb-0 fw-bold text-primary me-4">
                <img src="{{ url_for('static', filename='favicon.png') }}" width="24" height="24" class="me-2" style="border-radius: 4px;">
                Scanner Pro Dashboard
            </h4>
            <div class="d-flex gap-3">
                <span class="badge bg-light text-dark border px-3 py-2"><i class="bi bi-search text-primary"></i> æ£€æµ‹ä¸­: [[ activeDetectCount ]]</span>
                <span class="badge bg-light text-dark border px-3 py-2"><i class="bi bi-cloud-arrow-up text-info"></i> ä¸Šä¼ ä¸­: [[ activeUploadCount ]]</span>
            </div>
        </div>
        <div>
            <button class="btn btn-outline-danger me-2 px-3" @click="confirmAction('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ã€å·²å®Œæˆ/è¿è§„/é”™è¯¯/å·²å–æ¶ˆã€‘çš„ä»»åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', () => clearHistory())"><i class="bi bi-trash"></i> æ¸…ç©ºå†å²</button>
            <a href="/settings_page" class="btn btn-outline-secondary me-2 px-3"><i class="bi bi-gear-fill"></i> è®¾ç½®</a>
            <a href="/logout" class="btn btn-outline-danger px-3"><i class="bi bi-box-arrow-right"></i></a>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-light pt-3 pb-0 border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item"><button class="nav-link" :class="{active: view==='detect'}" @click="view='detect'">ğŸ” æ£€æµ‹é˜Ÿåˆ— <span class="badge bg-secondary rounded-pill ms-1" v-if="detectTasks.length > 0">[[ detectTasks.length ]]</span></button></li>
                <li class="nav-item"><button class="nav-link" :class="{active: view==='upload'}" @click="view='upload'">â˜ï¸ ä¸Šä¼ é˜Ÿåˆ— <span class="badge bg-secondary rounded-pill ms-1" v-if="uploadTasks.length > 0">[[ uploadTasks.length ]]</span></button></li>
                <li class="nav-item"><button class="nav-link" :class="{active: view==='syslog'}" @click="view='syslog'">ğŸ“œ ç³»ç»Ÿæ—¥å¿—</button></li>
            </ul>
        </div>

        <div class="card-body p-0 border-top bg-white">

            <div v-if="view==='detect'">
                <div class="p-2 border-bottom d-flex gap-2 bg-light bg-opacity-50 ps-3">
                    <button class="btn btn-sm btn-outline-primary" @click="batchAction('detect', 'retry')"><i class="bi bi-arrow-repeat me-1"></i>å…¨éƒ¨é‡è¯• (é”™è¯¯/å–æ¶ˆ)</button>
                    <button class="btn btn-sm btn-outline-danger" @click="batchAction('detect', 'stop')"><i class="bi bi-stop-circle me-1"></i>å…¨éƒ¨åœæ­¢</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light"><tr><th class="text-center">ID</th><th>æ–‡ä»¶ä¿¡æ¯</th><th class="text-center">çŠ¶æ€æŒ‡ç¤º</th><th class="text-center">ç»“æœ</th><th>å®æ—¶æ—¥å¿— (åŒå‡»å…¨å±)</th><th class="text-end pe-4">æ“ä½œ</th></tr></thead>
                        <tbody>
                            <tr v-for="t in detectTasks" :key="t.id">
                                <td class="text-center fw-bold text-muted">[[ t.id ]]</td>
                                <td><div class="text-truncate fw-bold text-dark" style="max-width:280px" :title="t.filename"><i class="bi bi-file-earmark-play me-1"></i>[[ t.filename ]]</div><div class="small text-muted mt-1"><i class="bi bi-clock"></i> [[ t.created_at ]]</div></td>
                                <td class="text-center"><div class="d-flex justify-content-center bg-light rounded-pill py-1 px-2 border" style="width: fit-content; margin: 0 auto; gap:3px"><span v-for="i in 3" :class="['config-dot', getDotClass('audio', t, i)]"></span><span style="border-right:1px solid #ccc; margin:0 2px"></span><span :class="['config-dot', getDotClass('subtitle', t)]"></span><span :class="['config-dot', getDotClass('meta', t)]"></span></div></td>
                                <td class="text-center"><span class="badge rounded-pill" :class="bg(t.status)">[[ statusText[t.status]||t.status ]]</span></td>
                                <td style="width: 35%;"><div class="task-log-box" @dblclick="showFullLog(t)" v-html="fmt(t.log)"></div></td>
                                <td class="text-end pe-3">
                                    <div class="btn-group btn-group-sm">
                                        <button v-if="canControl(t)" class="btn btn-outline-primary" @click="openConfig(t)" title="è°ƒæ•´"><i class="bi bi-sliders"></i></button>
                                        <button v-if="canControl(t)" class="btn btn-outline-success" @click="confirmAction('ç¡®å®šè·³è¿‡æ£€æµ‹ç›´æ¥ä¸Šä¼ å—ï¼Ÿ', () => directUpload(t.id))" title="ç›´ä¼ "><i class="bi bi-forward-fill"></i></button>
                                        <button v-if="isRunning(t)" class="btn btn-outline-danger" @click="confirmAction('ç¡®å®šå¼ºåˆ¶åœæ­¢è¯¥ä»»åŠ¡å—ï¼Ÿ', () => cancel(t.id))" title="åœæ­¢"><i class="bi bi-stop-circle-fill"></i></button>
                                        <button v-if="isError(t)" class="btn btn-outline-secondary" @click="retry(t.id)" title="é‡è¯•"><i class="bi bi-arrow-clockwise"></i></button>
                                        <button class="btn btn-outline-danger" @click="confirmAction('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ', () => deleteTask(t.id))" title="åˆ é™¤"><i class="bi bi-trash-fill"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="detectTasks.length===0"><td colspan="6" class="text-center py-5 text-muted">å½“å‰æ²¡æœ‰ç­‰å¾…æ£€æµ‹çš„ä»»åŠ¡</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="view==='upload'">
                <div class="p-2 border-bottom d-flex gap-2 bg-light bg-opacity-50 ps-3">
                    <button class="btn btn-sm btn-outline-primary" @click="batchAction('upload', 'retry')"><i class="bi bi-arrow-repeat me-1"></i>å…¨éƒ¨é‡è¯• (é”™è¯¯/å–æ¶ˆ)</button>
                    <button class="btn btn-sm btn-outline-danger" @click="batchAction('upload', 'stop')"><i class="bi bi-stop-circle me-1"></i>å…¨éƒ¨åœæ­¢</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light"><tr><th class="text-center">ID</th><th>æ–‡ä»¶ä¿¡æ¯</th><th>ä¼ è¾“è¿›åº¦</th><th>é€Ÿåº¦ / ETA</th><th>ç»“æŸæ—¶é—´</th><th class="text-center">çŠ¶æ€</th><th class="text-end pe-4">æ“ä½œ</th></tr></thead>
                        <tbody>
                            <tr v-for="t in uploadTasks" :key="t.id">
                                <td class="text-center fw-bold text-muted">[[ t.id ]]</td>
                                <td class="text-truncate" style="max-width:250px" :title="t.filename"><i class="bi bi-file-earmark-arrow-up me-1"></i>[[ t.filename ]]</td>
                                <td><div class="progress bg-secondary bg-opacity-10" style="height: 12px; border-radius: 6px;"><div class="progress-bar progress-bar-striped progress-bar-animated" :style="{width: t.progress + '%'}" :class="t.status==='uploaded'?'bg-success':'bg-primary'"></div></div><div class="small text-end text-muted mt-1">[[ t.progress ]]%</div></td>
                                <td><div v-if="t.status==='uploading'" class="small"><div class="fw-bold text-dark">ğŸš€ [[ t.upload_speed ]]</div><div class="text-muted">â± [[ t.upload_eta ]]</div></div><div v-else class="text-muted small">-</div></td>
                                <td class="small text-muted">[[ t.finished_at || '-' ]]</td>
                                <td class="text-center"><span class="badge rounded-pill" :class="bg(t.status)">[[ statusText[t.status]||t.status ]]</span></td>
                                <td class="text-end pe-3"><div class="btn-group btn-group-sm"><button v-if="t.status==='uploading'" class="btn btn-outline-danger" @click="confirmAction('ç¡®å®šåœæ­¢ä¸Šä¼ ï¼Ÿ', () => cancel(t.id))"><i class="bi bi-stop-fill"></i></button><button v-if="t.status==='error' || t.status==='cancelled'" class="btn btn-outline-secondary" @click="retry(t.id)"><i class="bi bi-arrow-repeat"></i></button><button class="btn btn-outline-danger" @click="confirmAction('âš ï¸ ç¡®å®šåˆ é™¤æ­¤è®°å½•å—ï¼Ÿ', () => deleteTask(t.id))"><i class="bi bi-trash-fill"></i></button></div></td>
                            </tr>
                            <tr v-if="uploadTasks.length===0"><td colspan="7" class="text-center py-5 text-muted">æš‚æ— ä¸Šä¼ ä»»åŠ¡</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="view==='syslog'" class="p-0">
                <div class="bg-white p-2 border-bottom d-flex justify-content-between align-items-center px-4">
                    <div class="d-flex align-items-center gap-3">
                        <span class="fw-bold text-dark"><i class="bi bi-terminal-fill me-2 text-secondary"></i>System Logs</span>
                        <div class="input-group input-group-sm" style="width: 250px;"><span class="input-group-text bg-light"><i class="bi bi-funnel"></i></span><input type="text" class="form-control" v-model="sysLogFilter" placeholder="å…³é”®è¯è¿‡æ»¤..."><button class="btn btn-outline-secondary" v-if="sysLogFilter" @click="sysLogFilter=''">Ã—</button></div>
                        <div class="form-check form-switch mb-0"><input class="form-check-input" type="checkbox" v-model="autoRefreshLogs" id="autoRef"><label class="form-check-label small text-muted" for="autoRef">è‡ªåŠ¨</label></div>
                    </div>
                    <div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary" @click="loadSysLogs"><i class="bi bi-arrow-clockwise"></i></button><button class="btn btn-outline-danger" @click="confirmAction('ç¡®å®šæ¸…ç©ºç³»ç»Ÿæ—¥å¿—(journalctl)å—ï¼Ÿ', () => clearSysLogs())"><i class="bi bi-eraser-fill"></i></button></div>
                </div>
                <div class="sys-log-box m-0 border-0 rounded-0" id="sysLogBox">
                    <div v-for="(line, idx) in filteredSystemLogs" :key="idx" :class="getLogClass(line)" style="padding-left:5px">[[ line ]]</div>
                    <div v-if="!sysLogs" class="text-muted p-3">æ­£åœ¨è¯»å–ç³»ç»Ÿæ—¥å¿—...</div>
                </div>
            </div>

        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"><div id="liveToast" class="toast align-items-center text-white border-0" :class="toastClass" role="alert"><div class="d-flex"><div class="toast-body fs-6"><i :class="toastIcon" class="me-2 fs-5" style="vertical-align: middle;"></i> [[ toastMsg ]]</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content shadow"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i> ç¡®è®¤æ“ä½œ</h6></div><div class="modal-body text-center py-3" style="white-space: pre-line;">[[ confirmMsg ]]</div><div class="modal-footer border-0 pt-0 justify-content-center"><button type="button" class="btn btn-sm btn-light border px-3" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-sm btn-danger px-3" @click="executeConfirm">ç¡®å®šæ‰§è¡Œ</button></div></div></div></div>
    <div class="modal fade" id="fullLogModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content bg-dark border-secondary"><div class="modal-header border-secondary py-2"><h6 class="modal-title text-light font-monospace text-truncate w-75"><i class="bi bi-file-text me-2"></i>[[ currentLogTitle ]]</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="full-log-content">[[ currentLogContent ]]</div></div></div></div></div>
    <div class="modal fade" id="configModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">ğŸ”§ è°ƒæ•´æ£€æµ‹ç­–ç•¥</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" v-if="curTask.config"><div class="alert alert-info small mb-3">ä»»åŠ¡ <b>#[[ curTask.id ]]</b> ç‹¬ç«‹è®¾ç½®ã€‚</div><div class="form-check form-switch mb-3 ps-5"><input class="form-check-input" type="checkbox" v-model="curTask.config.check_audio" style="scale: 1.3;"><label class="form-check-label ms-2">éŸ³é¢‘æ£€æµ‹</label></div><div class="form-check form-switch mb-3 ps-5"><input class="form-check-input" type="checkbox" v-model="curTask.config.check_subtitles" style="scale: 1.3;"><label class="form-check-label ms-2">å­—å¹•æ¸…æ´—</label></div><div class="form-check form-switch ps-5"><input class="form-check-input" type="checkbox" v-model="curTask.config.sanitize_metadata" style="scale: 1.3;"><label class="form-check-label ms-2">å…ƒæ•°æ®æ¸…é™¤</label></div></div><div class="modal-footer bg-light"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" @click="saveAndRetry">é‡è¯•</button></div></div></div></div>

</div>

<script>
let modalConfig, modalLog, modalConfirm, toastInstance;
Vue.createApp({
    delimiters: ['[[', ']]'],
    data(){ return { tasks:[], view:'detect', curTask:{}, sysLogs:'', sysLogFilter:'', autoRefreshLogs:true, currentLogTitle:'', currentLogContent:'', statusText:{'pending':'â³ ç­‰å¾…ä¸­','processing':'ğŸ”„ æ£€æµ‹ä¸­','pending_upload':'âœ… å¾…ä¸Šä¼ ','uploading':'â˜ï¸ ä¸Šä¼ ä¸­','uploaded':'ğŸ‰ å·²å®Œæˆ','dirty':'ğŸš« å·²æ‹¦æˆª','error':'âŒ å‡ºé”™äº†','cancelled':'â¹ å·²åœæ­¢'}, toastMsg:'', toastClass:'bg-primary', toastIcon:'bi-info-circle', confirmMsg:'', confirmCallback:null, pollTimer: null }},
    computed: {
        filteredSystemLogs() { if(!this.sysLogs)return[]; const l=this.sysLogs.split('\n'); if(!this.sysLogFilter.trim())return l; const k=this.sysLogFilter.toLowerCase(); return l.filter(x=>x.toLowerCase().includes(k)) },
        detectTasks() { return this.tasks.filter(t => !this.isUploadTask(t)) },
        uploadTasks() { return this.tasks.filter(t => this.isUploadTask(t)) },
        activeDetectCount() { return this.tasks.filter(t => t.status === 'processing').length },
        activeUploadCount() { return this.tasks.filter(t => t.status === 'uploading').length }
    },
    mounted(){
        this.load();
        this.startPolling();
        setInterval(()=>{if(this.view==='syslog'&&this.autoRefreshLogs)this.loadSysLogs(true)}, 5000);
        modalConfig=new bootstrap.Modal(document.getElementById('configModal'));
        modalLog=new bootstrap.Modal(document.getElementById('fullLogModal'));
        modalConfirm=new bootstrap.Modal(document.getElementById('confirmModal'));
        toastInstance=new bootstrap.Toast(document.getElementById('liveToast'))
    },
    watch: { view(n) { if(n==='syslog') { if(!this.sysLogs)this.loadSysLogs(); this.$nextTick(()=>{ const b=document.getElementById('sysLogBox'); if(b)b.scrollTop=b.scrollHeight }) } } },
    methods:{
        isUploadTask(t) {
            if(['pending_upload', 'uploading', 'uploaded'].includes(t.status)) return true;
            if(['error', 'cancelled', 'dirty'].includes(t.status)) {
                if(t.config && t.config.direct_upload) return true;
                if(t.upload_speed || (t.upload_eta && t.upload_eta !== '-')) return true;
                const log = t.log || '';
                if(log.includes('â˜ï¸ ä¸Šä¼ ') || log.includes('=== æ‰¹é‡é‡ä¼  ===') || log.includes('=== ç›´ä¼  ===')) return true;
            }
            return false;
        },
        getLogClass(l) { if(l.includes('Error')||l.includes('âŒ')||l.includes('Fail'))return 'text-danger fw-bold'; if(l.includes('âœ…')||l.includes('Success'))return 'text-success'; if(l.includes('Warning')||l.includes('âš ï¸'))return 'text-warning'; if(l.includes('Task-'))return 'text-info'; return '' },

        load(){
            if(!document.getElementById('configModal').classList.contains('show')) {
                return axios.get('/api/tasks').then(r=>this.tasks=r.data)
            }
            return Promise.resolve();
        },

        startPolling() {
            const step = () => {
                this.load().finally(() => {
                    const busy = this.activeDetectCount > 0 || this.activeUploadCount > 0;
                    const delay = busy ? 1000 : 3000;
                    this.pollTimer = setTimeout(step, delay);
                });
            };
            step();
        },

        bg(s){ return {'uploaded':'bg-success','dirty':'bg-danger','processing':'bg-primary','pending_upload':'bg-success text-white','uploading':'bg-info text-dark'}[s]||'bg-secondary' },
        fmt(l){ return l?l.replace(/\n/g,'<br>'):'' },
        getDotClass(type,t,idx) {
            let p=t.progress||0;
            if(type==='audio'&&!t.config.check_audio)return 'dot-off'; if(type==='subtitle'&&!t.config.check_subtitles)return 'dot-off'; if(type==='meta'&&!t.config.sanitize_metadata)return 'dot-off';
            if(['pending_upload','uploading','uploaded'].includes(t.status))return 'dot-on'; if(t.status==='dirty')return 'dot-dirty';
            if(t.status==='processing'){ if(type==='meta')return p>=10?'dot-on':'dot-processing'; if(type==='subtitle')return p>=30?'dot-on':(p>=10?'dot-processing':'dot-off'); if(type==='audio'){ let th=50+(idx-1)*15; if(p>=th+15)return 'dot-on'; if(p>=th)return 'dot-processing'; return 'dot-off' } } return 'dot-off';
        },
        showToast(m,t='success'){ this.toastMsg=m; this.toastClass=t==='success'?'bg-success':'bg-danger'; this.toastIcon=t==='success'?'bi-check-circle-fill':'bi-exclamation-triangle-fill'; toastInstance.show() },
        confirmAction(m,a){ this.confirmMsg=m; this.confirmCallback=a; modalConfirm.show() },
        executeConfirm(){ if(this.confirmCallback)this.confirmCallback(); modalConfirm.hide() },
        loadSysLogs(s=false){ if(!s)this.sysLogs='è¯»å–ä¸­...'; axios.get('/api/system_logs?lines=9999&t='+Date.now()).then(r=>{ this.sysLogs=r.data.data; const b=document.getElementById('sysLogBox'); if(b&&(b.scrollHeight-b.scrollTop-b.clientHeight<100||!s))this.$nextTick(()=>b.scrollTop=b.scrollHeight) }) },
        clearSysLogs(){ axios.post('/api/system_logs/clear').then(r=>{ this.loadSysLogs(); this.showToast(r.data.msg) }) },
        showFullLog(t){ this.currentLogTitle=t.filename; this.currentLogContent=t.log; modalLog.show() },
        isRunning(t){ return ['processing','uploading'].includes(t.status) }, isError(t){ return ['error','cancelled','dirty'].includes(t.status) }, canControl(t){ return ['pending','dirty','error','cancelled'].includes(t.status) },
        cancel(id){ axios.post('/api/cancel/'+id).then(()=>{ this.load(); this.showToast('ä»»åŠ¡å·²åœæ­¢','error') }) },
        retry(id){ axios.post('/api/retry/'+id).then(()=>{ this.load(); this.showToast('é‡è¯•ä»»åŠ¡') }) },
        directUpload(id){ axios.post(`/api/task/${id}/direct_upload`).then(()=>{ this.load(); this.showToast('åˆ‡æ¢ç›´ä¼ ') }) },
        deleteTask(id){ axios.post(`/api/task/${id}/delete`).then(r=>{ this.showToast(r.data.msg); this.load() }) },
        clearHistory(){ axios.post('/api/tasks/clear').then(r=>{ this.showToast(r.data.msg); this.load() }) },
        openConfig(t){ this.curTask=JSON.parse(JSON.stringify(t)); modalConfig.show() },
        saveAndRetry(){ axios.post(`/api/task/${this.curTask.id}/save_and_retry`,this.curTask.config).then(()=>{ modalConfig.hide(); this.load(); this.showToast('ç­–ç•¥æ›´æ–°') }) },

        batchAction(type, action) {
            const actName = action==='retry'?'é‡è¯•':'åœæ­¢';
            this.confirmAction(`ç¡®å®šè¦å¯¹å½“å‰åˆ—è¡¨æ‰§è¡Œã€å…¨éƒ¨${actName}ã€‘å—ï¼Ÿ`, () => {
                axios.post('/api/tasks/batch', {type, action}).then(res => {
                    this.showToast(res.data.msg);
                    this.load();
                });
            });
        }
    }
}).mount('#app')
</script>
</body>
</html>
