# [新增] 定义上游 Python 服务（开启长连接池）
# 建议将你的 Flask应用端口改为 5001，避免与 Nginx 监听的 5000 冲突
upstream flask_backend {
    server 127.0.0.1:5000;
    keepalive 32;  # [优化] 保持与后端连接，减少握手消耗
}

server
{
    listen 5001 ssl;
    listen 5001 quic;
    http2 on;
    ##旧版本
    #listen 5001 ssl http;
    server_name nodehd.jiemo.de;

    #隐藏强迫症警告
    add_header Permissions-Policy "browsing-topics=()";
    #与安装目录一致
    root /www/wwwroot/scanner_web;
    #限制上传，暂未使用
    client_max_body_size 1024M;

    # [新增] 安全响应头：防止点击劫持、XSS 等攻击
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    #CERT-APPLY-CHECK--START
    # 用于SSL证书申请时的文件验证相关配置 ...
    #SSL-END

    # [删除] Flask 不使用 PHP，注释掉此行以防干扰
    # include enable-php-00.conf;

    # [新增] 静态资源加速 (核心优化)
    location /static/ {
        # ⚠️ 请确保这是你 Flask 项目中 static 文件夹的真实绝对路径
        alias /www/wwwroot/scanner_web/static/;
        expires 7d;      # 浏览器缓存 7 天
        access_log off;  # 不记录日志，减少磁盘 I/O
    }

    # [新增] 核心反向代理配置
    location / {
        proxy_pass http://flask_backend; # 指向上面定义的 upstream

        # 传递真实 IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # [优化] 启用 HTTP/1.1 长连接 (极大降低前端轮询时的 CPU 消耗)
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # [优化] 延长超时时间 (防止检测/上传大文件时 Nginx 提前断开)
        proxy_connect_timeout 600s;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;

        # [优化] 开启缓冲
        proxy_buffering on;
    }

    # [注释] 原有的静态文件正则匹配建议注释掉
    # 因为我们已经有了更高效的 location /static/ 配置。
    # 如果你的根目录下还有 robots.txt 或 favicon.ico，可以保留下面这段，否则建议注释。
    # location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    # {
    #    expires      30d;
    #    error_log /dev/null;
    #    access_log /dev/null;
    # }

    # location ~ .*\.(js|css)?$
    # {
    #    expires      12h;
    #    error_log /dev/null;
    #    access_log /dev/null;
    # }
}